<html>
<head>
  <title>SpringApplication类的初始化流程分析</title>
  <basefont face="mononoki" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600986 (zh-CN, DDL); Windows/6.1.1 (Win64); EDAMVersion=V2;"/>
  <meta name="content-class" content="yinxiang.markdown"/>
  <style>
    body, td {
      font-family: mononoki;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="709"/>

<div><span><div style="font-size: 14px; margin: 0; padding: 0; width: 100%;"><h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">SpringApplication类详解</h5>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">在分析SpringApplication的初始化流程之前，先来看一下SpringApplication类的相关说明</p>
<blockquote style="line-height: 160%; box-sizing: content-box; margin: 15px 0; border-left: 4px solid #ddd; padding: 0 15px; color: #777;">
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333; margin-top: 0; margin-bottom: 0;">SpringApplication类被用作启动类，从Java的main方法中启动一个Spring应用程序。默认情况下，您的应用程序在启动的时候，SpringApplication类将会执行以下步骤：</p>
</blockquote>
<ol style="line-height: 160%; box-sizing: content-box; display: block; padding-left: 30px; margin: 6px 0 10px; color: #333; list-style-type: decimal;">
<li style="line-height: 160%; box-sizing: content-box;">创建一个适当的ApplicationContext实例(根据您的类路径)</li>
<li style="line-height: 160%; box-sizing: content-box;">注册一个CommandLinePropertySource用于将命令行参数作为Spring的属性暴露出来</li>
<li style="line-height: 160%; box-sizing: content-box;">刷新应用程序上下文，加载所有的单例bean</li>
<li style="line-height: 160%; box-sizing: content-box;">触发所有实现了CommandLineRunner接口的的bean</li>
</ol>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">在大多数情况下，可以直接从您应用程序的<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">main</strong>方法调用SpringApplication的静态<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">run(Class, String[])</strong> 方法来引导应用程序。示例代码如下：</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">@Configuration</span>
<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">@EnableAutoConfiguration</span>
 <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">public</span> <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">class</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">MyApplication</span>  </span>{

   <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ... Bean definitions</span>

   <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">public</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">static</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">void</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">main</span><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(String[] args)</span> </span>{
     SpringApplication.run(MyApplication.class, args);
   }
 }
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">对于更高级的配置，在运行SpringApplication的<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">run</strong>方法之前，可以创建和定制化一个SpringApplication的实例，如下代码所示：</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">public</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">static</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">void</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">main</span><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(String[] args)</span> </span>{
   SpringApplication application = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> SpringApplication(MyApplication.class);
   <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// ... customize application settings here</span>
   application.run(args)
 }

</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">SpringApplication可以从各种不同的源中读取bean的信息，通常推荐使用单个 <strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">@Configuration</strong>类去启动您的用用程序，但是，您也从以下地方设置来源：</p>
<ol style="line-height: 160%; box-sizing: content-box; display: block; padding-left: 30px; margin: 6px 0 10px; color: #333; list-style-type: decimal;">
<li style="line-height: 160%; box-sizing: content-box;">通过<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">AnnotatedBeanDefinitionReader</strong>去加载完全限定的类名</li>
<li style="line-height: 160%; box-sizing: content-box;">通过<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">XmlBeanDefinitionReader</strong>去定位XML的资源位置并加载，或者使用<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">GroovyBeanDefinitionReader</strong> 去加载一个groovy的脚本</li>
<li style="line-height: 160%; box-sizing: content-box;">通过<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">ClassPathBeanDefinitionScanner</strong>去扫描指定的包名</li>
</ol>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">配置属性也可以绑定到SpringApplication上，这样可以动态的设置SpringApplication的属性，类似其他源(spring.main.sources)标签，例如表示一个web环境（spring.main.web-application-type=none）或者关闭banner输出的标签(spring.main.banner-mode=off)</p>
<h5 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 16px; color: #333;">SpringApplication初始化流程分析</h5>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">程序入口源码如下：</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">@SpringBootApplication</span>
<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">public</span> <span style="color: #b8d7a3; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">class</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">SpringbootApplication</span> </span>{
      <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">public</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">static</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">void</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">main</span><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(String[] args)</span> </span>{
        SpringApplication.run(SpringbootApplication.class, args);
      }
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">1.</strong> 首先调用了org.springframework.boot.SpringApplication类中的静态run方法，代码如下：</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/**
* 静态辅助类被用于从指定源来运行SpringApplication，使用默认设置
* <span style="color: #608b4e; line-height: 160%; box-sizing: content-box;">@param</span> primarySource 加载主要的源
* <span style="color: #608b4e; line-height: 160%; box-sizing: content-box;">@param</span> args 应用程序参数(通常从Java的main方法传递过来)
* <span style="color: #608b4e; line-height: 160%; box-sizing: content-box;">@return</span> 返回一个运行的ApplicationContext对象
*/</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">public</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">static</span> ConfigurableApplicationContext <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">run</span><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(Class&lt;?&gt; primarySource, String... args)</span> </span>{
    <span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">//将参数primarySource包装成一个Class类型的数组</span>
    <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> run(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> Class&lt;?&gt;[] { primarySource }, args);
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">2.</strong> 接着执行如下方法，在静态方法中实例化一个SpringApplication对象，并传递Class类型的数组参数：primarySources，然后在调用实例化后的run方法</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">public</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">static</span> ConfigurableApplicationContext <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">run</span><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(Class&lt;?&gt;[] primarySources, String[] args)</span> </span>{
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> SpringApplication(primarySources).run(args);
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">3.</strong> 然后执行SpringApplication的构造方法，传递Class类型的数组参数：primarySources，并调用其他构造函数</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/**
* 创建一个SpringApplication的实例，应用程序上下文将会从特定的主源中加载bean的信息
*/</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">public</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">SpringApplication</span><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(Class&lt;?&gt;... primarySources)</span> </span>{
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>(<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>, primarySources);
}

<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">public</span> <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">SpringApplication</span><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> </span>{
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>.resourceLoader = resourceLoader;
	Assert.notNull(primarySources, <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">&quot;PrimarySources must not be null&quot;</span>);
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>.primarySources = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> LinkedHashSet&lt;&gt;(Arrays.asList(primarySources));
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();
	setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));
	setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">this</span>.mainApplicationClass = deduceMainApplicationClass();
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">在构造方法中完成了如下事情：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">给资源加载器resourceLoader赋空值，resourceLoader=null;</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">断言，判定primarySources参数是否为空;</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">将primarySources参数转成集合，并去重</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">从类路径中推断应用程序的类型，webApplicationType=SERVLET</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">根据应用程序上下文初始化器参数，从指定包的中的spring.factories文件加载工厂名称并将其缓存起来，之后通过Spring工厂加载器来创建相应工厂的实例，并设置到初始化器集合中</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">根据应用程序监听器参数，从缓存中获取相应的工厂参数并实例化，最后设置到监听器集合中</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">从当前方法的调用栈信息中推断出主应用程序类(SpringbootApplication.class)，并赋值给mainApplicationClass</li>
</ul>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">4.</strong> 接下来，我们分析一下<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">WebApplicationType.deduceFromClasspath()</strong> 方法</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">static</span> WebApplicationType <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">deduceFromClasspath</span><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">()</span> </span>{
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>)
			&amp;&amp; !ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>)
			&amp;&amp; !ClassUtils.isPresent(JERSEY_INDICATOR_CLASS, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>)) {
		<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> WebApplicationType.REACTIVE;
	}
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span> (String className : SERVLET_INDICATOR_CLASSES) {
		<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (!ClassUtils.isPresent(className, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>)) {
			<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> WebApplicationType.NONE;
		}
	}
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> WebApplicationType.SERVLET;
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">可以发现会调用ClassUtils类的isPresent()方法，检查classpath中是否存在<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">javax.servlet.Servlet</strong>类和<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">org.springframework.web.context.ConfigurableWebApplicationContext</strong>类,如果存在的话,返回true.否则返回false.</p>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">5.</strong> 在设置初始化器之前，先调用<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">getSpringFactoriesInstances</strong>方法，传入<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">ApplicationContextInitializer.class</strong>参数</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">private</span> &lt;T&gt; <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">Collection&lt;T&gt; <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">getSpringFactoriesInstances</span><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(Class&lt;T&gt; type)</span> </span>{
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> getSpringFactoriesInstances(type, <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> Class&lt;?&gt;[] {});
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">6.</strong> 转而调用另外一个同名的方法</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">private</span> &lt;T&gt; <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">Collection&lt;T&gt; <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">getSpringFactoriesInstances</span><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(Class&lt;T&gt; type, Class&lt;?&gt;[] parameterTypes, Object... args)</span> </span>{
	ClassLoader classLoader = getClassLoader();
	<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// 使用set集合来确保名称唯一且不重复</span>
	Set&lt;String&gt; names = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> LinkedHashSet&lt;&gt;(SpringFactoriesLoader.loadFactoryNames(type, classLoader));
	List&lt;T&gt; instances = createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);
	AnnotationAwareOrderComparator.sort(instances);
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> instances;
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">分析上诉方法的代码逻辑：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">获取类加载器，首先判断资源加载器是否为空，如果不为空，就是返回使用加载资源的类加载器，否则，再从线程上下文获取类加载器，如果为空，则从加载使用加载ClassUtil类的类加载器，如果还为空，就使用系统类加载器，然后返回，总之该类加载器一定会有值</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">传入<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">ApplicationContextInitializer.class</strong>和<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">classLoader</strong>参数，调用<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">SpringFactoriesLoader#loadFactoryNames</strong>方法从spring.factories文件中获取工厂名称的集合，并放入set集合中</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">调用 <strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">createSpringFactoriesInstances</strong>方法实例化获取到的工厂名称</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">对实例化的进行排序</li>
</ul>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">7.</strong> 接下来看一下<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">SpringFactoriesLoader#loadFactoryNames</strong>源码</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">/**
 * 使用给定的类加载器，从&quot;META-INF/spring.factories&quot;文件中加载给定类型工厂实现的完全限定类名
 * <span style="color: #608b4e; line-height: 160%; box-sizing: content-box;">@param</span> factoryClass 表示工厂的接口或抽象类
 * <span style="color: #608b4e; line-height: 160%; box-sizing: content-box;">@param</span> classLoader  用于加载资源的类加载器
 */</span>
<span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">public</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">static</span> List&lt;String&gt; <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">loadFactoryNames</span><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(Class&lt;?&gt; factoryClass, @Nullable ClassLoader classLoader)</span> </span>{
	String factoryClassName = factoryClass.getName();
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> loadSpringFactories(classLoader).getOrDefault(factoryClassName, Collections.emptyList());
}

<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">private</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">static</span> Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(<span style="color: #9b9b9b; line-height: 160%; box-sizing: content-box;">@Nullable</span> ClassLoader classLoader) {
	MultiValueMap&lt;String, String&gt; result = cache.get(classLoader);
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (result != <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>) {
		<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> result;
	}

	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">try</span> {
		Enumeration&lt;URL&gt; urls = (classLoader != <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span> ?
				classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :
				ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));
		result = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> LinkedMultiValueMap&lt;&gt;();
		<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">while</span> (urls.hasMoreElements()) {
			URL url = urls.nextElement();
			UrlResource resource = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> UrlResource(url);
			Properties properties = PropertiesLoaderUtils.loadProperties(resource);
			<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span> (Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) {
				String factoryClassName = ((String) entry.getKey()).trim();
				<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span> (String factoryName : StringUtils.commaDelimitedListToStringArray((String) entry.getValue())) {
					result.add(factoryClassName, factoryName.trim());
				}
			}
		}
		cache.put(classLoader, result);
		<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> result;
	}
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">catch</span> (IOException ex) {
		<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">throw</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> IllegalArgumentException(<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">&quot;Unable to load factories from location [&quot;</span> +
				FACTORIES_RESOURCE_LOCATION + <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">&quot;]&quot;</span>, ex);
	}
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">方法逻辑如下：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">获取工厂类的名称，当前类来说<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">factoryClassName=org.springframework.context.ApplicationContextInitializer</strong>；</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">使用类加载器从给定的文件“META-INF/spring.factories”中加载资源，spring.factories文件分别再spring-boot-autoconfigure-2.1.3.RELEASE.jar、spring-boot-2.1.3.RELEASE.jar、spring-beans-5.1.5.RELEASE.jar这三个包中，也就说，会循环从这三个包中的spring.factories文件加载相应的资源；</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">通过调用PropertiesLoaderUtils#loadProperties将文件中的资源转为Properties属性对象</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">将Properties资源添加到MultiValueMap中，以<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">factoryClassName</strong>作为key，然后将转成Properties属性对象中的value作为value</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">最后在以<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">classLoader作为key</strong>，存储的到MultiValueMap对象中的资源作为value，放入<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">缓存</strong>中(Map&lt;ClassLoader, MultiValueMap&lt;String, String&gt;&gt;)</li>
</ul>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">8.</strong> 再来看<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">SpringApplication#createSpringFactoriesInstances()</strong> 方法的源码</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">private</span> &lt;T&gt; <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">List&lt;T&gt; <span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">createSpringFactoriesInstances</span><span style="color: #dcdcdc; line-height: 160%; box-sizing: content-box;">(Class&lt;T&gt; type,
			Class&lt;?&gt;[] parameterTypes, ClassLoader classLoader, Object[] args,
			Set&lt;String&gt; names)</span> </span>{
	List&lt;T&gt; instances = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> ArrayList&lt;&gt;(names.size());
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span> (String name : names) {
		<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">try</span> {
			Class&lt;?&gt; instanceClass = ClassUtils.forName(name, classLoader);
			Assert.isAssignable(type, instanceClass);
			Constructor&lt;?&gt; constructor = instanceClass
					.getDeclaredConstructor(parameterTypes);
			T instance = (T) BeanUtils.instantiateClass(constructor, args);
			instances.add(instance);
		}
		<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">catch</span> (Throwable ex) {
			<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">throw</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> IllegalArgumentException(
					<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">&quot;Cannot instantiate &quot;</span> + type + <span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">&quot; : &quot;</span> + name, ex);
		}
	}
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> instances;
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">以上方法中names参数分别是从&quot;META-INF/spring.factories&quot;文件中获取到<br/>
spring-boot-autoconfigure-2.1.3.RELEASE.jar中的spring-boot-autoconfigure/META-INF/spring.factories中org.springframework.context.ApplicationContextInitializer的值如下</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"># Initializers
org.springframework.context.ApplicationContextInitializer=\
org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer,\
org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">spring-boot-2.1.3.RELEASE.jar包中的spring-boot/META-INF/spring.factories中org.springframework.context.ApplicationContextInitializer的值如下</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"># Application Context Initializers
org.springframework.context.ApplicationContextInitializer=\
org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer,\
org.springframework.boot.context.ContextIdApplicationContextInitializer,\
org.springframework.boot.context.config.DelegatingApplicationContextInitializer,\
org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">因此names就是上述6个，spring-boot-autoconfigure-2.1.3.RELEASE.jar包中2个，spring-boot-2.1.3.RELEASE.jar包中4个，spring-beans-5.1.5.RELEASE.jar包中没有<br/>
上述方法的逻辑是：</p>
<ul style="line-height: 160%; box-sizing: content-box; display: block; list-style-type: disc; padding-left: 30px; margin: 6px 0 10px; color: #333;">
<li style="line-height: 160%; box-sizing: content-box; position: relative;">循环遍历names参数，然后通过java的反射方式，循环初始化每个类，然后根据给定的参数类型分别获取其构造方法，最后根据构造法进行实例化</li>
<li style="line-height: 160%; box-sizing: content-box; position: relative;">最后再将实例化好的应用程序上下文初始化器调用<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">SpringApplication#setInitializers</strong>方法添加到<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">initializers</strong>集合中</li>
</ul>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">9.</strong> 设置<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">SpringApplication#setListeners</strong>时,还是同样的套路.调用getSpringFactoriesInstances方法加载META-INF/spring.factories中配置的<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">org.springframework.context.ApplicationListener</strong>，此处就不在重复叙述了，参照第5步开始的逻辑<br/>
从spring.factories文件中加载到的类如下所示：<br/>
<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">spring-boot-autoconfigure-2.1.3.RELEASE.jar</strong></p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"># Application Listeners
org.springframework.context.ApplicationListener=\
org.springframework.boot.autoconfigure.BackgroundPreinitializer
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">spring-boot-2.1.3.RELEASE.jar</strong></p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"># Application Listeners
org.springframework.context.ApplicationListener=\
org.springframework.boot.ClearCachesApplicationListener,\
org.springframework.boot.builder.ParentContextCloserApplicationListener,\
org.springframework.boot.context.FileEncodingApplicationListener,\
org.springframework.boot.context.config.AnsiOutputApplicationListener,\
org.springframework.boot.context.config.ConfigFileApplicationListener,\
org.springframework.boot.context.config.DelegatingApplicationListener,\
org.springframework.boot.context.logging.ClasspathLoggingApplicationListener,\
org.springframework.boot.context.logging.LoggingApplicationListener,\
org.springframework.boot.liquibase.LiquibaseServiceLocatorApplicationListener
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">10.</strong> 调用<strong style="line-height: 160%; box-sizing: content-box; font-weight: 700;">SpringApplication#deduceMainApplicationClass</strong>方法，获得当前应用的启动类。通过获取当前方法调用栈，找到main函数的类.代码如下:</p>
<pre style="line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; margin: 2px 0 8px; background-color: #f5f7f8;"><code style="display: block; overflow-x: auto; background: #1e1e1e; line-height: 160%; box-sizing: content-box; border: 0; border-radius: 0; letter-spacing: -.3px; padding: 18px; color: #f4f4f4; white-space: pre-wrap;"><span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">private</span> Class&lt;?&gt; deduceMainApplicationClass() {
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">try</span> {
		StackTraceElement[] stackTrace = <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">new</span> RuntimeException().getStackTrace();
		<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">for</span> (StackTraceElement stackTraceElement : stackTrace) {
			<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">if</span> (<span style="color: #d69d85; line-height: 160%; box-sizing: content-box;">&quot;main&quot;</span>.equals(stackTraceElement.getMethodName())) {
				<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> Class.forName(stackTraceElement.getClassName());
			}
		}
	}
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">catch</span> (ClassNotFoundException ex) {
		<span style="color: #57a64a; font-style: italic; line-height: 160%; box-sizing: content-box;">// Swallow and continue</span>
	}
	<span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">return</span> <span style="color: #569cd6; line-height: 160%; box-sizing: content-box;">null</span>;
}
</code></pre>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;">整个SpringApplication的实例化过程就到此结束了。</p>
</div><center style="display:none !important;visibility:collapse !important;height:0 !important;white-space:nowrap;width:100%;overflow:hidden">%23%23%23%23%23%20SpringApplication%E7%B1%BB%E8%AF%A6%E8%A7%A3%0A%E5%9C%A8%E5%88%86%E6%9E%90SpringApplication%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B9%8B%E5%89%8D%EF%BC%8C%E5%85%88%E6%9D%A5%E7%9C%8B%E4%B8%80%E4%B8%8BSpringApplication%E7%B1%BB%E7%9A%84%E7%9B%B8%E5%85%B3%E8%AF%B4%E6%98%8E%0A%0A%3E%20SpringApplication%E7%B1%BB%E8%A2%AB%E7%94%A8%E4%BD%9C%E5%90%AF%E5%8A%A8%E7%B1%BB%EF%BC%8C%E4%BB%8EJava%E7%9A%84main%E6%96%B9%E6%B3%95%E4%B8%AD%E5%90%AF%E5%8A%A8%E4%B8%80%E4%B8%AASpring%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E3%80%82%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E6%82%A8%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%9C%A8%E5%90%AF%E5%8A%A8%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8CSpringApplication%E7%B1%BB%E5%B0%86%E4%BC%9A%E6%89%A7%E8%A1%8C%E4%BB%A5%E4%B8%8B%E6%AD%A5%E9%AA%A4%EF%BC%9A%0A%0A1.%20%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E9%80%82%E5%BD%93%E7%9A%84ApplicationContext%E5%AE%9E%E4%BE%8B(%E6%A0%B9%E6%8D%AE%E6%82%A8%E7%9A%84%E7%B1%BB%E8%B7%AF%E5%BE%84)%0A2.%20%E6%B3%A8%E5%86%8C%E4%B8%80%E4%B8%AACommandLinePropertySource%E7%94%A8%E4%BA%8E%E5%B0%86%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%E4%BD%9C%E4%B8%BASpring%E7%9A%84%E5%B1%9E%E6%80%A7%E6%9A%B4%E9%9C%B2%E5%87%BA%E6%9D%A5%0A3.%20%E5%88%B7%E6%96%B0%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%B8%8A%E4%B8%8B%E6%96%87%EF%BC%8C%E5%8A%A0%E8%BD%BD%E6%89%80%E6%9C%89%E7%9A%84%E5%8D%95%E4%BE%8Bbean%0A4.%20%E8%A7%A6%E5%8F%91%E6%89%80%E6%9C%89%E5%AE%9E%E7%8E%B0%E4%BA%86CommandLineRunner%E6%8E%A5%E5%8F%A3%E7%9A%84%E7%9A%84bean%0A%0A%E5%9C%A8%E5%A4%A7%E5%A4%9A%E6%95%B0%E6%83%85%E5%86%B5%E4%B8%8B%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9B%B4%E6%8E%A5%E4%BB%8E%E6%82%A8%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9A%84**main**%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8SpringApplication%E7%9A%84%E9%9D%99%E6%80%81**run(Class%2C%20String%5B%5D)**%20%E6%96%B9%E6%B3%95%E6%9D%A5%E5%BC%95%E5%AF%BC%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E3%80%82%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%60%60%60java%0A%40Configuration%0A%40EnableAutoConfiguration%0A%20public%20class%20MyApplication%20%20%7B%0A%0A%20%20%20%2F%2F%20...%20Bean%20definitions%0A%0A%20%20%20public%20static%20void%20main(String%5B%5D%20args)%20%7B%0A%20%20%20%20%20SpringApplication.run(MyApplication.class%2C%20args)%3B%0A%20%20%20%7D%0A%20%7D%0A%60%60%60%0A%E5%AF%B9%E4%BA%8E%E6%9B%B4%E9%AB%98%E7%BA%A7%E7%9A%84%E9%85%8D%E7%BD%AE%EF%BC%8C%E5%9C%A8%E8%BF%90%E8%A1%8CSpringApplication%E7%9A%84**run**%E6%96%B9%E6%B3%95%E4%B9%8B%E5%89%8D%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%88%9B%E5%BB%BA%E5%92%8C%E5%AE%9A%E5%88%B6%E5%8C%96%E4%B8%80%E4%B8%AASpringApplication%E7%9A%84%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%A6%82%E4%B8%8B%E4%BB%A3%E7%A0%81%E6%89%80%E7%A4%BA%EF%BC%9A%0A%60%60%60java%0Apublic%20static%20void%20main(String%5B%5D%20args)%20%7B%0A%20%20%20SpringApplication%20application%20%3D%20new%20SpringApplication(MyApplication.class)%3B%0A%20%20%20%2F%2F%20...%20customize%20application%20settings%20here%0A%20%20%20application.run(args)%0A%20%7D%0A%0A%60%60%60%0ASpringApplication%E5%8F%AF%E4%BB%A5%E4%BB%8E%E5%90%84%E7%A7%8D%E4%B8%8D%E5%90%8C%E7%9A%84%E6%BA%90%E4%B8%AD%E8%AF%BB%E5%8F%96bean%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%8C%E9%80%9A%E5%B8%B8%E6%8E%A8%E8%8D%90%E4%BD%BF%E7%94%A8%E5%8D%95%E4%B8%AA%20**%40Configuration**%E7%B1%BB%E5%8E%BB%E5%90%AF%E5%8A%A8%E6%82%A8%E7%9A%84%E7%94%A8%E7%94%A8%E7%A8%8B%E5%BA%8F%EF%BC%8C%E4%BD%86%E6%98%AF%EF%BC%8C%E6%82%A8%E4%B9%9F%E4%BB%8E%E4%BB%A5%E4%B8%8B%E5%9C%B0%E6%96%B9%E8%AE%BE%E7%BD%AE%E6%9D%A5%E6%BA%90%EF%BC%9A%0A%0A1.%20%E9%80%9A%E8%BF%87**AnnotatedBeanDefinitionReader**%E5%8E%BB%E5%8A%A0%E8%BD%BD%E5%AE%8C%E5%85%A8%E9%99%90%E5%AE%9A%E7%9A%84%E7%B1%BB%E5%90%8D%0A2.%20%E9%80%9A%E8%BF%87**XmlBeanDefinitionReader**%E5%8E%BB%E5%AE%9A%E4%BD%8DXML%E7%9A%84%E8%B5%84%E6%BA%90%E4%BD%8D%E7%BD%AE%E5%B9%B6%E5%8A%A0%E8%BD%BD%EF%BC%8C%E6%88%96%E8%80%85%E4%BD%BF%E7%94%A8**GroovyBeanDefinitionReader**%20%E5%8E%BB%E5%8A%A0%E8%BD%BD%E4%B8%80%E4%B8%AAgroovy%E7%9A%84%E8%84%9A%E6%9C%AC%0A3.%20%E9%80%9A%E8%BF%87**ClassPathBeanDefinitionScanner**%E5%8E%BB%E6%89%AB%E6%8F%8F%E6%8C%87%E5%AE%9A%E7%9A%84%E5%8C%85%E5%90%8D%0A%0A%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%BB%91%E5%AE%9A%E5%88%B0SpringApplication%E4%B8%8A%EF%BC%8C%E8%BF%99%E6%A0%B7%E5%8F%AF%E4%BB%A5%E5%8A%A8%E6%80%81%E7%9A%84%E8%AE%BE%E7%BD%AESpringApplication%E7%9A%84%E5%B1%9E%E6%80%A7%EF%BC%8C%E7%B1%BB%E4%BC%BC%E5%85%B6%E4%BB%96%E6%BA%90(spring.main.sources)%E6%A0%87%E7%AD%BE%EF%BC%8C%E4%BE%8B%E5%A6%82%E8%A1%A8%E7%A4%BA%E4%B8%80%E4%B8%AAweb%E7%8E%AF%E5%A2%83%EF%BC%88spring.main.web-application-type%3Dnone%EF%BC%89%E6%88%96%E8%80%85%E5%85%B3%E9%97%ADbanner%E8%BE%93%E5%87%BA%E7%9A%84%E6%A0%87%E7%AD%BE(spring.main.banner-mode%3Doff)%0A%0A%23%23%23%23%23%20SpringApplication%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90%0A%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3%E6%BA%90%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%60%60%60java%0A%40SpringBootApplication%0Apublic%20class%20SpringbootApplication%20%7B%0A%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0%C2%A0public%20static%20void%20main(String%5B%5D%20args)%20%7B%0A%20%20%20%20%20%20%20%20SpringApplication.run(SpringbootApplication.class%2C%20args)%3B%0A%20%20%20%20%20%20%7D%0A%7D%0A%60%60%60%0A%0A**1.**%20%E9%A6%96%E5%85%88%E8%B0%83%E7%94%A8%E4%BA%86org.springframework.boot.SpringApplication%E7%B1%BB%E4%B8%AD%E7%9A%84%E9%9D%99%E6%80%81run%E6%96%B9%E6%B3%95%EF%BC%8C%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A%0A%60%60%60java%0A%2F**%0A*%20%E9%9D%99%E6%80%81%E8%BE%85%E5%8A%A9%E7%B1%BB%E8%A2%AB%E7%94%A8%E4%BA%8E%E4%BB%8E%E6%8C%87%E5%AE%9A%E6%BA%90%E6%9D%A5%E8%BF%90%E8%A1%8CSpringApplication%EF%BC%8C%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E8%AE%BE%E7%BD%AE%0A*%20%40param%20primarySource%20%E5%8A%A0%E8%BD%BD%E4%B8%BB%E8%A6%81%E7%9A%84%E6%BA%90%0A*%20%40param%20args%20%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%8F%82%E6%95%B0(%E9%80%9A%E5%B8%B8%E4%BB%8EJava%E7%9A%84main%E6%96%B9%E6%B3%95%E4%BC%A0%E9%80%92%E8%BF%87%E6%9D%A5)%0A*%20%40return%20%E8%BF%94%E5%9B%9E%E4%B8%80%E4%B8%AA%E8%BF%90%E8%A1%8C%E7%9A%84ApplicationContext%E5%AF%B9%E8%B1%A1%0A*%2F%0Apublic%20static%20ConfigurableApplicationContext%20run(Class%3C%3F%3E%20primarySource%2C%C2%A0String...%20args)%20%7B%0A%20%20%20%20%2F%2F%E5%B0%86%E5%8F%82%E6%95%B0primarySource%E5%8C%85%E8%A3%85%E6%88%90%E4%B8%80%E4%B8%AAClass%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%95%B0%E7%BB%84%0A%20%20%20%20return%20run(new%20Class%3C%3F%3E%5B%5D%20%7B%20primarySource%20%7D%2C%20args)%3B%0A%7D%0A%60%60%60%0A**2.**%20%E6%8E%A5%E7%9D%80%E6%89%A7%E8%A1%8C%E5%A6%82%E4%B8%8B%E6%96%B9%E6%B3%95%EF%BC%8C%E5%9C%A8%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95%E4%B8%AD%E5%AE%9E%E4%BE%8B%E5%8C%96%E4%B8%80%E4%B8%AASpringApplication%E5%AF%B9%E8%B1%A1%EF%BC%8C%E5%B9%B6%E4%BC%A0%E9%80%92Class%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%95%B0%E7%BB%84%E5%8F%82%E6%95%B0%EF%BC%9AprimarySources%EF%BC%8C%E7%84%B6%E5%90%8E%E5%9C%A8%E8%B0%83%E7%94%A8%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%90%8E%E7%9A%84run%E6%96%B9%E6%B3%95%0A%60%60%60java%0Apublic%20static%20ConfigurableApplicationContext%20run(Class%3C%3F%3E%5B%5D%20primarySources%2C%20String%5B%5D%20args)%20%7B%0A%09return%20new%20SpringApplication(primarySources).run(args)%3B%0A%7D%0A%60%60%60%0A**3.**%20%E7%84%B6%E5%90%8E%E6%89%A7%E8%A1%8CSpringApplication%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%EF%BC%8C%E4%BC%A0%E9%80%92Class%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%95%B0%E7%BB%84%E5%8F%82%E6%95%B0%EF%BC%9AprimarySources%EF%BC%8C%E5%B9%B6%E8%B0%83%E7%94%A8%E5%85%B6%E4%BB%96%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%0A%60%60%60java%0A%2F**%0A*%20%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AASpringApplication%E7%9A%84%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B0%86%E4%BC%9A%E4%BB%8E%E7%89%B9%E5%AE%9A%E7%9A%84%E4%B8%BB%E6%BA%90%E4%B8%AD%E5%8A%A0%E8%BD%BDbean%E7%9A%84%E4%BF%A1%E6%81%AF%0A*%2F%0Apublic%20SpringApplication(Class%3C%3F%3E...%20primarySources)%20%7B%0A%09this(null%2C%20primarySources)%3B%0A%7D%0A%0Apublic%20SpringApplication(ResourceLoader%20resourceLoader%2C%20Class%3C%3F%3E...%20primarySources)%20%7B%0A%09this.resourceLoader%20%3D%20resourceLoader%3B%0A%09Assert.notNull(primarySources%2C%20%22PrimarySources%20must%20not%20be%20null%22)%3B%0A%09this.primarySources%20%3D%20new%20LinkedHashSet%3C%3E(Arrays.asList(primarySources))%3B%0A%09this.webApplicationType%20%3D%20WebApplicationType.deduceFromClasspath()%3B%0A%09setInitializers((Collection)%20getSpringFactoriesInstances(ApplicationContextInitializer.class))%3B%0A%09setListeners((Collection)%20getSpringFactoriesInstances(ApplicationListener.class))%3B%0A%09this.mainApplicationClass%20%3D%20deduceMainApplicationClass()%3B%0A%7D%0A%60%60%60%0A%E5%9C%A8%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E4%B8%AD%E5%AE%8C%E6%88%90%E4%BA%86%E5%A6%82%E4%B8%8B%E4%BA%8B%E6%83%85%EF%BC%9A%0A-%20%20%E7%BB%99%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E5%99%A8resourceLoader%E8%B5%8B%E7%A9%BA%E5%80%BC%EF%BC%8CresourceLoader%3Dnull%3B%0A-%20%20%E6%96%AD%E8%A8%80%EF%BC%8C%E5%88%A4%E5%AE%9AprimarySources%E5%8F%82%E6%95%B0%E6%98%AF%E5%90%A6%E4%B8%BA%E7%A9%BA%3B%0A-%20%20%E5%B0%86primarySources%E5%8F%82%E6%95%B0%E8%BD%AC%E6%88%90%E9%9B%86%E5%90%88%EF%BC%8C%E5%B9%B6%E5%8E%BB%E9%87%8D%0A-%20%20%E4%BB%8E%E7%B1%BB%E8%B7%AF%E5%BE%84%E4%B8%AD%E6%8E%A8%E6%96%AD%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%B1%BB%E5%9E%8B%EF%BC%8CwebApplicationType%3DSERVLET%0A-%20%20%E6%A0%B9%E6%8D%AE%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%9D%E5%A7%8B%E5%8C%96%E5%99%A8%E5%8F%82%E6%95%B0%EF%BC%8C%E4%BB%8E%E6%8C%87%E5%AE%9A%E5%8C%85%E7%9A%84%E4%B8%AD%E7%9A%84spring.factories%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E5%B7%A5%E5%8E%82%E5%90%8D%E7%A7%B0%E5%B9%B6%E5%B0%86%E5%85%B6%E7%BC%93%E5%AD%98%E8%B5%B7%E6%9D%A5%EF%BC%8C%E4%B9%8B%E5%90%8E%E9%80%9A%E8%BF%87Spring%E5%B7%A5%E5%8E%82%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%9D%A5%E5%88%9B%E5%BB%BA%E7%9B%B8%E5%BA%94%E5%B7%A5%E5%8E%82%E7%9A%84%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%88%B0%E5%88%9D%E5%A7%8B%E5%8C%96%E5%99%A8%E9%9B%86%E5%90%88%E4%B8%AD%0A-%20%20%E6%A0%B9%E6%8D%AE%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%9B%91%E5%90%AC%E5%99%A8%E5%8F%82%E6%95%B0%EF%BC%8C%E4%BB%8E%E7%BC%93%E5%AD%98%E4%B8%AD%E8%8E%B7%E5%8F%96%E7%9B%B8%E5%BA%94%E7%9A%84%E5%B7%A5%E5%8E%82%E5%8F%82%E6%95%B0%E5%B9%B6%E5%AE%9E%E4%BE%8B%E5%8C%96%EF%BC%8C%E6%9C%80%E5%90%8E%E8%AE%BE%E7%BD%AE%E5%88%B0%E7%9B%91%E5%90%AC%E5%99%A8%E9%9B%86%E5%90%88%E4%B8%AD%0A-%20%20%E4%BB%8E%E5%BD%93%E5%89%8D%E6%96%B9%E6%B3%95%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88%E4%BF%A1%E6%81%AF%E4%B8%AD%E6%8E%A8%E6%96%AD%E5%87%BA%E4%B8%BB%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E7%B1%BB(SpringbootApplication.class)%EF%BC%8C%E5%B9%B6%E8%B5%8B%E5%80%BC%E7%BB%99mainApplicationClass%0A%0A**4.**%20%E6%8E%A5%E4%B8%8B%E6%9D%A5%EF%BC%8C%E6%88%91%E4%BB%AC%E5%88%86%E6%9E%90%E4%B8%80%E4%B8%8B**WebApplicationType.deduceFromClasspath()**%20%E6%96%B9%E6%B3%95%0A%60%60%60java%0Astatic%20WebApplicationType%20deduceFromClasspath()%20%7B%0A%09if%20(ClassUtils.isPresent(WEBFLUX_INDICATOR_CLASS%2C%20null)%0A%09%09%09%26%26%20!ClassUtils.isPresent(WEBMVC_INDICATOR_CLASS%2C%20null)%0A%09%09%09%26%26%20!ClassUtils.isPresent(JERSEY_INDICATOR_CLASS%2C%20null))%20%7B%0A%09%09return%20WebApplicationType.REACTIVE%3B%0A%09%7D%0A%09for%20(String%20className%20%3A%20SERVLET_INDICATOR_CLASSES)%20%7B%0A%09%09if%20(!ClassUtils.isPresent(className%2C%20null))%20%7B%0A%09%09%09return%20WebApplicationType.NONE%3B%0A%09%09%7D%0A%09%7D%0A%09return%20WebApplicationType.SERVLET%3B%0A%7D%0A%60%60%60%0A%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E4%BC%9A%E8%B0%83%E7%94%A8ClassUtils%E7%B1%BB%E7%9A%84isPresent()%E6%96%B9%E6%B3%95%EF%BC%8C%E6%A3%80%E6%9F%A5classpath%E4%B8%AD%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8**javax.servlet.Servlet**%E7%B1%BB%E5%92%8C**org.springframework.web.context.ConfigurableWebApplicationContext**%E7%B1%BB%2C%E5%A6%82%E6%9E%9C%E5%AD%98%E5%9C%A8%E7%9A%84%E8%AF%9D%2C%E8%BF%94%E5%9B%9Etrue.%E5%90%A6%E5%88%99%E8%BF%94%E5%9B%9Efalse.%0A%0A**5.**%20%E5%9C%A8%E8%AE%BE%E7%BD%AE%E5%88%9D%E5%A7%8B%E5%8C%96%E5%99%A8%E4%B9%8B%E5%89%8D%EF%BC%8C%E5%85%88%E8%B0%83%E7%94%A8**getSpringFactoriesInstances**%E6%96%B9%E6%B3%95%EF%BC%8C%E4%BC%A0%E5%85%A5**ApplicationContextInitializer.class**%E5%8F%82%E6%95%B0%0A%60%60%60java%0Aprivate%20%3CT%3E%20Collection%3CT%3E%20getSpringFactoriesInstances(Class%3CT%3E%20type)%20%7B%0A%09return%20getSpringFactoriesInstances(type%2C%20new%20Class%3C%3F%3E%5B%5D%20%7B%7D)%3B%0A%7D%0A%60%60%60%0A**6.**%20%E8%BD%AC%E8%80%8C%E8%B0%83%E7%94%A8%E5%8F%A6%E5%A4%96%E4%B8%80%E4%B8%AA%E5%90%8C%E5%90%8D%E7%9A%84%E6%96%B9%E6%B3%95%0A%60%60%60java%0Aprivate%20%3CT%3E%20Collection%3CT%3E%20getSpringFactoriesInstances(Class%3CT%3E%20type%2C%20Class%3C%3F%3E%5B%5D%20parameterTypes%2C%20Object...%20args)%20%7B%0A%09ClassLoader%20classLoader%20%3D%20getClassLoader()%3B%0A%09%2F%2F%20%E4%BD%BF%E7%94%A8set%E9%9B%86%E5%90%88%E6%9D%A5%E7%A1%AE%E4%BF%9D%E5%90%8D%E7%A7%B0%E5%94%AF%E4%B8%80%E4%B8%94%E4%B8%8D%E9%87%8D%E5%A4%8D%0A%09Set%3CString%3E%20names%20%3D%20new%20LinkedHashSet%3C%3E(SpringFactoriesLoader.loadFactoryNames(type%2C%20classLoader))%3B%0A%09List%3CT%3E%20instances%20%3D%20createSpringFactoriesInstances(type%2C%20parameterTypes%2C%20classLoader%2C%20args%2C%20names)%3B%0A%09AnnotationAwareOrderComparator.sort(instances)%3B%0A%09return%20instances%3B%0A%7D%0A%60%60%60%0A%E5%88%86%E6%9E%90%E4%B8%8A%E8%AF%89%E6%96%B9%E6%B3%95%E7%9A%84%E4%BB%A3%E7%A0%81%E9%80%BB%E8%BE%91%EF%BC%9A%0A*%20%E8%8E%B7%E5%8F%96%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%EF%BC%8C%E9%A6%96%E5%85%88%E5%88%A4%E6%96%AD%E8%B5%84%E6%BA%90%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%98%AF%E5%90%A6%E4%B8%BA%E7%A9%BA%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%8D%E4%B8%BA%E7%A9%BA%EF%BC%8C%E5%B0%B1%E6%98%AF%E8%BF%94%E5%9B%9E%E4%BD%BF%E7%94%A8%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%EF%BC%8C%E5%90%A6%E5%88%99%EF%BC%8C%E5%86%8D%E4%BB%8E%E7%BA%BF%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E8%8E%B7%E5%8F%96%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%BA%E7%A9%BA%EF%BC%8C%E5%88%99%E4%BB%8E%E5%8A%A0%E8%BD%BD%E4%BD%BF%E7%94%A8%E5%8A%A0%E8%BD%BDClassUtil%E7%B1%BB%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%EF%BC%8C%E5%A6%82%E6%9E%9C%E8%BF%98%E4%B8%BA%E7%A9%BA%EF%BC%8C%E5%B0%B1%E4%BD%BF%E7%94%A8%E7%B3%BB%E7%BB%9F%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%EF%BC%8C%E7%84%B6%E5%90%8E%E8%BF%94%E5%9B%9E%EF%BC%8C%E6%80%BB%E4%B9%8B%E8%AF%A5%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E4%B8%80%E5%AE%9A%E4%BC%9A%E6%9C%89%E5%80%BC%0A*%20%E4%BC%A0%E5%85%A5**ApplicationContextInitializer.class**%E5%92%8C**classLoader**%E5%8F%82%E6%95%B0%EF%BC%8C%E8%B0%83%E7%94%A8**SpringFactoriesLoader%23loadFactoryNames**%E6%96%B9%E6%B3%95%E4%BB%8Espring.factories%E6%96%87%E4%BB%B6%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%B7%A5%E5%8E%82%E5%90%8D%E7%A7%B0%E7%9A%84%E9%9B%86%E5%90%88%EF%BC%8C%E5%B9%B6%E6%94%BE%E5%85%A5set%E9%9B%86%E5%90%88%E4%B8%AD%0A*%20%E8%B0%83%E7%94%A8%20**createSpringFactoriesInstances**%E6%96%B9%E6%B3%95%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%8E%B7%E5%8F%96%E5%88%B0%E7%9A%84%E5%B7%A5%E5%8E%82%E5%90%8D%E7%A7%B0%0A*%20%E5%AF%B9%E5%AE%9E%E4%BE%8B%E5%8C%96%E7%9A%84%E8%BF%9B%E8%A1%8C%E6%8E%92%E5%BA%8F%0A%0A**7.**%20%E6%8E%A5%E4%B8%8B%E6%9D%A5%E7%9C%8B%E4%B8%80%E4%B8%8B**SpringFactoriesLoader%23loadFactoryNames**%E6%BA%90%E7%A0%81%0A%60%60%60java%0A%2F**%0A%20*%20%E4%BD%BF%E7%94%A8%E7%BB%99%E5%AE%9A%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%EF%BC%8C%E4%BB%8E%22META-INF%2Fspring.factories%22%E6%96%87%E4%BB%B6%E4%B8%AD%E5%8A%A0%E8%BD%BD%E7%BB%99%E5%AE%9A%E7%B1%BB%E5%9E%8B%E5%B7%A5%E5%8E%82%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%AE%8C%E5%85%A8%E9%99%90%E5%AE%9A%E7%B1%BB%E5%90%8D%0A%20*%20%40param%20factoryClass%20%E8%A1%A8%E7%A4%BA%E5%B7%A5%E5%8E%82%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%88%96%E6%8A%BD%E8%B1%A1%E7%B1%BB%0A%20*%20%40param%20classLoader%20%20%E7%94%A8%E4%BA%8E%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%0A%20*%2F%0Apublic%20static%20List%3CString%3E%20loadFactoryNames(Class%3C%3F%3E%20factoryClass%2C%20%40Nullable%20ClassLoader%20classLoader)%20%7B%0A%09String%20factoryClassName%20%3D%20factoryClass.getName()%3B%0A%09return%20loadSpringFactories(classLoader).getOrDefault(factoryClassName%2C%20Collections.emptyList())%3B%0A%7D%0A%0Aprivate%20static%20Map%3CString%2C%20List%3CString%3E%3E%20loadSpringFactories(%40Nullable%20ClassLoader%20classLoader)%20%7B%0A%09MultiValueMap%3CString%2C%20String%3E%20result%20%3D%20cache.get(classLoader)%3B%0A%09if%20(result%20!%3D%20null)%20%7B%0A%09%09return%20result%3B%0A%09%7D%0A%0A%09try%20%7B%0A%09%09Enumeration%3CURL%3E%20urls%20%3D%20(classLoader%20!%3D%20null%20%3F%0A%09%09%09%09classLoader.getResources(FACTORIES_RESOURCE_LOCATION)%20%3A%0A%09%09%09%09ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION))%3B%0A%09%09result%20%3D%20new%20LinkedMultiValueMap%3C%3E()%3B%0A%09%09while%20(urls.hasMoreElements())%20%7B%0A%09%09%09URL%20url%20%3D%20urls.nextElement()%3B%0A%09%09%09UrlResource%20resource%20%3D%20new%20UrlResource(url)%3B%0A%09%09%09Properties%20properties%20%3D%20PropertiesLoaderUtils.loadProperties(resource)%3B%0A%09%09%09for%20(Map.Entry%3C%3F%2C%20%3F%3E%20entry%20%3A%20properties.entrySet())%20%7B%0A%09%09%09%09String%20factoryClassName%20%3D%20((String)%20entry.getKey()).trim()%3B%0A%09%09%09%09for%20(String%20factoryName%20%3A%20StringUtils.commaDelimitedListToStringArray((String)%20entry.getValue()))%20%7B%0A%09%09%09%09%09result.add(factoryClassName%2C%20factoryName.trim())%3B%0A%09%09%09%09%7D%0A%09%09%09%7D%0A%09%09%7D%0A%09%09cache.put(classLoader%2C%20result)%3B%0A%09%09return%20result%3B%0A%09%7D%0A%09catch%20(IOException%20ex)%20%7B%0A%09%09throw%20new%20IllegalArgumentException(%22Unable%20to%20load%20factories%20from%20location%20%5B%22%20%2B%0A%09%09%09%09FACTORIES_RESOURCE_LOCATION%20%2B%20%22%5D%22%2C%20ex)%3B%0A%09%7D%0A%7D%0A%60%60%60%0A%E6%96%B9%E6%B3%95%E9%80%BB%E8%BE%91%E5%A6%82%E4%B8%8B%EF%BC%9A%0A*%20%E8%8E%B7%E5%8F%96%E5%B7%A5%E5%8E%82%E7%B1%BB%E7%9A%84%E5%90%8D%E7%A7%B0%EF%BC%8C%E5%BD%93%E5%89%8D%E7%B1%BB%E6%9D%A5%E8%AF%B4**factoryClassName%3Dorg.springframework.context.ApplicationContextInitializer**%EF%BC%9B%0A*%20%E4%BD%BF%E7%94%A8%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E4%BB%8E%E7%BB%99%E5%AE%9A%E7%9A%84%E6%96%87%E4%BB%B6%E2%80%9CMETA-INF%2Fspring.factories%E2%80%9D%E4%B8%AD%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%EF%BC%8Cspring.factories%E6%96%87%E4%BB%B6%E5%88%86%E5%88%AB%E5%86%8Dspring-boot-autoconfigure-2.1.3.RELEASE.jar%E3%80%81spring-boot-2.1.3.RELEASE.jar%E3%80%81spring-beans-5.1.5.RELEASE.jar%E8%BF%99%E4%B8%89%E4%B8%AA%E5%8C%85%E4%B8%AD%EF%BC%8C%E4%B9%9F%E5%B0%B1%E8%AF%B4%EF%BC%8C%E4%BC%9A%E5%BE%AA%E7%8E%AF%E4%BB%8E%E8%BF%99%E4%B8%89%E4%B8%AA%E5%8C%85%E4%B8%AD%E7%9A%84spring.factories%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E7%9B%B8%E5%BA%94%E7%9A%84%E8%B5%84%E6%BA%90%EF%BC%9B%0A*%20%E9%80%9A%E8%BF%87%E8%B0%83%E7%94%A8PropertiesLoaderUtils%23loadProperties%E5%B0%86%E6%96%87%E4%BB%B6%E4%B8%AD%E7%9A%84%E8%B5%84%E6%BA%90%E8%BD%AC%E4%B8%BAProperties%E5%B1%9E%E6%80%A7%E5%AF%B9%E8%B1%A1%0A*%20%E5%B0%86Properties%E8%B5%84%E6%BA%90%E6%B7%BB%E5%8A%A0%E5%88%B0MultiValueMap%E4%B8%AD%EF%BC%8C%E4%BB%A5**factoryClassName**%E4%BD%9C%E4%B8%BAkey%EF%BC%8C%E7%84%B6%E5%90%8E%E5%B0%86%E8%BD%AC%E6%88%90Properties%E5%B1%9E%E6%80%A7%E5%AF%B9%E8%B1%A1%E4%B8%AD%E7%9A%84value%E4%BD%9C%E4%B8%BAvalue%0A*%20%E6%9C%80%E5%90%8E%E5%9C%A8%E4%BB%A5**classLoader%E4%BD%9C%E4%B8%BAkey**%EF%BC%8C%E5%AD%98%E5%82%A8%E7%9A%84%E5%88%B0MultiValueMap%E5%AF%B9%E8%B1%A1%E4%B8%AD%E7%9A%84%E8%B5%84%E6%BA%90%E4%BD%9C%E4%B8%BAvalue%EF%BC%8C%E6%94%BE%E5%85%A5**%E7%BC%93%E5%AD%98**%E4%B8%AD(Map%3CClassLoader%2C%20MultiValueMap%3CString%2C%20String%3E%3E)%0A%0A**8.**%20%E5%86%8D%E6%9D%A5%E7%9C%8B**SpringApplication%23createSpringFactoriesInstances()**%20%E6%96%B9%E6%B3%95%E7%9A%84%E6%BA%90%E7%A0%81%0A%60%60%60java%0Aprivate%20%3CT%3E%20List%3CT%3E%20createSpringFactoriesInstances(Class%3CT%3E%20type%2C%0A%09%09%09Class%3C%3F%3E%5B%5D%20parameterTypes%2C%20ClassLoader%20classLoader%2C%20Object%5B%5D%20args%2C%0A%09%09%09Set%3CString%3E%20names)%20%7B%0A%09List%3CT%3E%20instances%20%3D%20new%20ArrayList%3C%3E(names.size())%3B%0A%09for%20(String%20name%20%3A%20names)%20%7B%0A%09%09try%20%7B%0A%09%09%09Class%3C%3F%3E%20instanceClass%20%3D%20ClassUtils.forName(name%2C%20classLoader)%3B%0A%09%09%09Assert.isAssignable(type%2C%20instanceClass)%3B%0A%09%09%09Constructor%3C%3F%3E%20constructor%20%3D%20instanceClass%0A%09%09%09%09%09.getDeclaredConstructor(parameterTypes)%3B%0A%09%09%09T%20instance%20%3D%20(T)%20BeanUtils.instantiateClass(constructor%2C%20args)%3B%0A%09%09%09instances.add(instance)%3B%0A%09%09%7D%0A%09%09catch%20(Throwable%20ex)%20%7B%0A%09%09%09throw%20new%20IllegalArgumentException(%0A%09%09%09%09%09%22Cannot%20instantiate%20%22%20%2B%20type%20%2B%20%22%20%3A%20%22%20%2B%20name%2C%20ex)%3B%0A%09%09%7D%0A%09%7D%0A%09return%20instances%3B%0A%7D%0A%60%60%60%0A%E4%BB%A5%E4%B8%8A%E6%96%B9%E6%B3%95%E4%B8%ADnames%E5%8F%82%E6%95%B0%E5%88%86%E5%88%AB%E6%98%AF%E4%BB%8E%22META-INF%2Fspring.factories%22%E6%96%87%E4%BB%B6%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%88%B0%0A%20%20%20%20spring-boot-autoconfigure-2.1.3.RELEASE.jar%E4%B8%AD%E7%9A%84spring-boot-autoconfigure%2FMETA-INF%2Fspring.factories%E4%B8%ADorg.springframework.context.ApplicationContextInitializer%E7%9A%84%E5%80%BC%E5%A6%82%E4%B8%8B%0A%60%60%60java%0A%23%20Initializers%0Aorg.springframework.context.ApplicationContextInitializer%3D%5C%0Aorg.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer%2C%5C%0Aorg.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener%0A%60%60%60%0Aspring-boot-2.1.3.RELEASE.jar%E5%8C%85%E4%B8%AD%E7%9A%84spring-boot%2FMETA-INF%2Fspring.factories%E4%B8%ADorg.springframework.context.ApplicationContextInitializer%E7%9A%84%E5%80%BC%E5%A6%82%E4%B8%8B%0A%60%60%60java%0A%23%20Application%20Context%20Initializers%0Aorg.springframework.context.ApplicationContextInitializer%3D%5C%0Aorg.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer%2C%5C%0Aorg.springframework.boot.context.ContextIdApplicationContextInitializer%2C%5C%0Aorg.springframework.boot.context.config.DelegatingApplicationContextInitializer%2C%5C%0Aorg.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer%0A%60%60%60%0A%E5%9B%A0%E6%AD%A4names%E5%B0%B1%E6%98%AF%E4%B8%8A%E8%BF%B06%E4%B8%AA%EF%BC%8Cspring-boot-autoconfigure-2.1.3.RELEASE.jar%E5%8C%85%E4%B8%AD2%E4%B8%AA%EF%BC%8Cspring-boot-2.1.3.RELEASE.jar%E5%8C%85%E4%B8%AD4%E4%B8%AA%EF%BC%8Cspring-beans-5.1.5.RELEASE.jar%E5%8C%85%E4%B8%AD%E6%B2%A1%E6%9C%89%0A%E4%B8%8A%E8%BF%B0%E6%96%B9%E6%B3%95%E7%9A%84%E9%80%BB%E8%BE%91%E6%98%AF%EF%BC%9A%0A*%20%E5%BE%AA%E7%8E%AF%E9%81%8D%E5%8E%86names%E5%8F%82%E6%95%B0%EF%BC%8C%E7%84%B6%E5%90%8E%E9%80%9A%E8%BF%87java%E7%9A%84%E5%8F%8D%E5%B0%84%E6%96%B9%E5%BC%8F%EF%BC%8C%E5%BE%AA%E7%8E%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E6%AF%8F%E4%B8%AA%E7%B1%BB%EF%BC%8C%E7%84%B6%E5%90%8E%E6%A0%B9%E6%8D%AE%E7%BB%99%E5%AE%9A%E7%9A%84%E5%8F%82%E6%95%B0%E7%B1%BB%E5%9E%8B%E5%88%86%E5%88%AB%E8%8E%B7%E5%8F%96%E5%85%B6%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%EF%BC%8C%E6%9C%80%E5%90%8E%E6%A0%B9%E6%8D%AE%E6%9E%84%E9%80%A0%E6%B3%95%E8%BF%9B%E8%A1%8C%E5%AE%9E%E4%BE%8B%E5%8C%96%0A*%20%E6%9C%80%E5%90%8E%E5%86%8D%E5%B0%86%E5%AE%9E%E4%BE%8B%E5%8C%96%E5%A5%BD%E7%9A%84%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%B8%8A%E4%B8%8B%E6%96%87%E5%88%9D%E5%A7%8B%E5%8C%96%E5%99%A8%E8%B0%83%E7%94%A8**SpringApplication%23setInitializers**%E6%96%B9%E6%B3%95%E6%B7%BB%E5%8A%A0%E5%88%B0**initializers**%E9%9B%86%E5%90%88%E4%B8%AD%0A%0A%0A**9.**%20%E8%AE%BE%E7%BD%AE**SpringApplication%23setListeners**%E6%97%B6%2C%E8%BF%98%E6%98%AF%E5%90%8C%E6%A0%B7%E7%9A%84%E5%A5%97%E8%B7%AF.%E8%B0%83%E7%94%A8getSpringFactoriesInstances%E6%96%B9%E6%B3%95%E5%8A%A0%E8%BD%BDMETA-INF%2Fspring.factories%E4%B8%AD%E9%85%8D%E7%BD%AE%E7%9A%84**org.springframework.context.ApplicationListener**%EF%BC%8C%E6%AD%A4%E5%A4%84%E5%B0%B1%E4%B8%8D%E5%9C%A8%E9%87%8D%E5%A4%8D%E5%8F%99%E8%BF%B0%E4%BA%86%EF%BC%8C%E5%8F%82%E7%85%A7%E7%AC%AC5%E6%AD%A5%E5%BC%80%E5%A7%8B%E7%9A%84%E9%80%BB%E8%BE%91%0A%E4%BB%8Espring.factories%E6%96%87%E4%BB%B6%E4%B8%AD%E5%8A%A0%E8%BD%BD%E5%88%B0%E7%9A%84%E7%B1%BB%E5%A6%82%E4%B8%8B%E6%89%80%E7%A4%BA%EF%BC%9A%0A**spring-boot-autoconfigure-2.1.3.RELEASE.jar**%0A%60%60%60java%0A%23%20Application%20Listeners%0Aorg.springframework.context.ApplicationListener%3D%5C%0Aorg.springframework.boot.autoconfigure.BackgroundPreinitializer%0A%60%60%60%0A**spring-boot-2.1.3.RELEASE.jar**%0A%60%60%60java%0A%23%20Application%20Listeners%0Aorg.springframework.context.ApplicationListener%3D%5C%0Aorg.springframework.boot.ClearCachesApplicationListener%2C%5C%0Aorg.springframework.boot.builder.ParentContextCloserApplicationListener%2C%5C%0Aorg.springframework.boot.context.FileEncodingApplicationListener%2C%5C%0Aorg.springframework.boot.context.config.AnsiOutputApplicationListener%2C%5C%0Aorg.springframework.boot.context.config.ConfigFileApplicationListener%2C%5C%0Aorg.springframework.boot.context.config.DelegatingApplicationListener%2C%5C%0Aorg.springframework.boot.context.logging.ClasspathLoggingApplicationListener%2C%5C%0Aorg.springframework.boot.context.logging.LoggingApplicationListener%2C%5C%0Aorg.springframework.boot.liquibase.LiquibaseServiceLocatorApplicationListener%0A%60%60%60%0A**10.**%20%E8%B0%83%E7%94%A8**SpringApplication%23deduceMainApplicationClass**%E6%96%B9%E6%B3%95%EF%BC%8C%E8%8E%B7%E5%BE%97%E5%BD%93%E5%89%8D%E5%BA%94%E7%94%A8%E7%9A%84%E5%90%AF%E5%8A%A8%E7%B1%BB%E3%80%82%E9%80%9A%E8%BF%87%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%A0%88%EF%BC%8C%E6%89%BE%E5%88%B0main%E5%87%BD%E6%95%B0%E7%9A%84%E7%B1%BB.%E4%BB%A3%E7%A0%81%E5%A6%82%E4%B8%8B%3A%0A%60%60%60java%0Aprivate%20Class%3C%3F%3E%20deduceMainApplicationClass()%20%7B%0A%09try%20%7B%0A%09%09StackTraceElement%5B%5D%20stackTrace%20%3D%20new%20RuntimeException().getStackTrace()%3B%0A%09%09for%20(StackTraceElement%20stackTraceElement%20%3A%20stackTrace)%20%7B%0A%09%09%09if%20(%22main%22.equals(stackTraceElement.getMethodName()))%20%7B%0A%09%09%09%09return%20Class.forName(stackTraceElement.getClassName())%3B%0A%09%09%09%7D%0A%09%09%7D%0A%09%7D%0A%09catch%20(ClassNotFoundException%20ex)%20%7B%0A%09%09%2F%2F%20Swallow%20and%20continue%0A%09%7D%0A%09return%20null%3B%0A%7D%0A%60%60%60%0A%E6%95%B4%E4%B8%AASpringApplication%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%BF%87%E7%A8%8B%E5%B0%B1%E5%88%B0%E6%AD%A4%E7%BB%93%E6%9D%9F%E4%BA%86%E3%80%82%0A</center></span>
</div></body></html> 